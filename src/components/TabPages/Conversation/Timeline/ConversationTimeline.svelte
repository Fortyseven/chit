<script>
    import { chatTimeline, inferringInProgress } from '$stores/stores.js';
    import { pendingResponse, responseInProgress } from '$lib/api/api';

    import TimelineResponse_User from './TimelineResponse_User.svelte';
    import TimelineResponse_Assistant from './TimelineResponse_Assistant.svelte';
    import TimelineResponseAssistant from './TimelineResponse_Assistant.svelte';
    import { scrollToBottom } from '$lib/chat';

    let pendingIndex = null;
    inferringInProgress.subscribe(async (value) => {
        console.log('inferringInProgress UPDATED', value);
        pendingIndex = value;
    });

    let responseScrollTimer = null;

    responseInProgress.subscribe(async (value) => {
        if (value) {
            if (responseScrollTimer) clearInterval(responseScrollTimer);

            responseScrollTimer = setInterval(() => {
                scrollToBottom();
            }, 250);
        } else {
            if (responseScrollTimer) clearInterval(responseScrollTimer);
        }
    });
</script>

<div class="timeline">
    {#each $chatTimeline as line, index}
        {#if line}
            {#if line.role === 'user'}
                <TimelineResponse_User {line} {index} {pendingIndex} />
            {:else if line.role === 'assistant'}
                <TimelineResponse_Assistant {line} {index} />
            {:else if line.role === 'error'}
                <div class="bot error">
                    {line.content}
                </div>
            {/if}
        {:else}
            <div class="bot">ðŸ’€</div>
        {/if}
    {/each}
    {#if $responseInProgress}
        <TimelineResponseAssistant line={$pendingResponse} index={-1} />
    {/if}
</div>

<style lang="scss">
    .timeline {
        // overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 0.75em;
        font-size: 1.35em;
    }
</style>
